# 캐시 메모리
속도가 빠른 장치와 느린 장치에서 속도 차이에 따른 병목 현상을 줄이기 위한 메모리를 말한다.

- CPU 코어와 주기억장치 사이의 병목 현상 완화
- 웹 브라우저 캐시 파일은 하드디스크와 웹페이지 사이의 병목 현상을 완화
- 주기억장치(DRAM)보다 액세스 속도가 더 높은 칩(SRAM) 사용
- 가격 및 제한된 공간때문에 용량이 적다.

CPU가 주기억장치에서 저장된 데이터를 읽어올 때, 자주 사용하는 데이터를 캐시 메모리에 저장한 뒤, 다음에 이용할 때 주기억장치가 아닌 캐시 메모리에서 먼저 가져오면서 속도를 향상시킨다.

CPU에 이러한 캐시 메모리가 2~3개 정도 사용된다. `L1, L2, L3 캐시 메모리`

속도와 크기에 따라 분류한 것으로, 일반적으로 L1 캐시부터 먼저 사용된다.(CPU에서 가장 빠르게 접근하고, L1에서 데이터를 찾지 못하면 L2로 이동)

**듀얼 코어 프로세서의 캐시 메모리**: 각 코어마다 독립된 L1 캐시 메모리를 가지고, 두 코어가 공유하는 L2 캐시 메모리가 내장됨

- 만약 L1 캐시가 128kb면, 64kb/64kb로 나누어 64kb에 명령어를 처리하기 직전의 명령어를 임시 저장하고, 나머지 64kb에는 실행 후 명령어를 임시저장한다. (명령어 세트로 구성, I-Cache, D-Cache)
    - L1: CPU 내부에 존재
    - L2: CPU와 RAM 사이에 존재
    - L3: 보통 메인보드에 존재한다고 함

디스크 캐시: 주기억장치(RAM)와 보조기억장치(하드디스크) 사이에 존재하는 캐시
<br>

### 캐시 메모리 작동 원리
- 시간 지역성(Temporal Locality)
    - for나 while 같은 반복문에 사용하는 조건 변수처럼 한 번 참조된 데이터는 잠시 후, 또 참조될 가능성이 높다.
<br>

- 공간적 지역성(Spatial Locality)
    - 기억장치내에 인접하여 저장되어 있는 데이터들이 연속적으로 액세스 될 가능성이 높다.
<br>

- 순차적 지역성(Sequential Locality)
    - 분기(branch)가 발생하지 않는 한, 명령어들은 기억장치에 저장된 순서대로 인출되어 실행된다.
<br>

캐시에 데이터를 저장할 때는, 이러한 참조 지역성(공간)을 최대한 활용하기 위해 해당 데이터뿐만 아니라, 옆 주소의 데이터도 같이 가져와 미래에 쓰일 것을 대비한다.
<br>
CPU가 요청한 데이터가 캐시에 있으면 'Cache Hit', 없어서 DRAM에서 가져오면 'Cache Miss'가 발생한다고 한다.

### 캐시 미스
1. Cold Miss
    해당 메모리 주소를 처음 불러서 발생하는 미스
2. Conflict Miss
    캐시 메모리에 A와 B 데이터를 저장해야 하는데, A와 B가 같은 캐시 메모리 주소에 할당되어 있어서 발생하는 미스(Direct Mapped Cache에서 많이 발생)
3. Capacity Miss
    캐시 메모리의 공간이 부족해서 발생하는 미스 (Conflict는 주소 할당 문제, Capacity는 공간 문제)

캐시 크기를 키워서 문제를 해결하려면, 캐시 접근 속도가 느려지고 파워를 많이 먹는 단점이 발생함.

### 캐시 메모리(Cache Memory)
- 블록(block): 주기억장치로부터 동시에 인출되는 정보들의 그룹
- 주기억장치 용량 = 2^n^ 단어, 블록 = K 단어
    &rightarrow; 블록의 수 = 2^n^/K개
- 라인(line): 캐시에서 각 블록이 저장되는 장소
- 태그(tag): 라인에 적재된 블록을 구분해주는 정보

### 사상 방식이란?
- 각 주기억장치 블록이 어느 캐시 라인에 적재될 것인지 결정해 주는 방식으로서, 캐시 내부 조직을 결정

### 캐시 메모리 구조 및 작동 방식

##### 직접 사상 캐시(Direct Mapped Cache)
각 주기억장치의 블록이 지정된 하나의 캐시 라인으로만 적재됨

- 주기억장치 주소 형식
    - 태그 필드(t 비트): 태그 번호(라인에 적재되어 있는 블록의 번호)
    - 라인 번호(l 비트): 캐시의 m = 2^l^개의 라인들 중의 하나를 지정
    - 단어 필드(w 필드): 각 블록 내 2^w^개 단어들 중의 하나를 구분

|태그(tag) 필드|라인(line) 필드|단어 필드|
|---|---|---|

##### 직접 사상 캐시의 예
- 주기억장치 용량 = 128(2^7^바이트)
- 주기억장치 주소 = 7비트(바이트 단위 주소 지정)
- 블록 크기 = 4바이트
    &rightarrow; 주기억장치는 128/4 = 32개의 블록들로 구성
- 캐시 용량 = 32바이트
- 캐시 라인 크기 = 4바이트 (블록 크기와 동일)
- 전체 캐시 라인의 수, m = 32/4 = 8개(3bit)
- 기억장치 주소 형식(태그:2bit, 라인:3bit, 단어:2bit)

##### 직접 사상 캐시의 장단점
- 장점: H/W가 간단하고, 구현 비용이 적게 든다.
- 단점: 각 주기억장치 블록이 적재될 수 있는 캐시 라인이 한 개 뿐이기 때문에, 그 라인을 공유하는 다른 블록이 적재되는 경우에는 Overwrite되거나 Swap-out 됨

![직접 사상 캐시1](https://github.com/rt21hyuk/TIL/assets/156268464/22a8295f-c69b-48ab-b9dc-9190e15ce7d1)
<br>

![직접 사상 캐시2](https://github.com/rt21hyuk/TIL/assets/156268464/77c61c51-55f3-43b4-8cd4-736ed7767dde)

##### 완전-연관 사상(Fully Associative Cache)
주기억장치 블록이 캐시의 어떤 라인으로든 적재 가능
태그 필드 = 주기억장치 블록 번호

- 기억장치 주소 형식

|태그(tag) 필드|단어 필드|
|---|---|

- 직접 사상 캐시의 예를 완전-연관 사상 방식에 적용
    (태그:5bit, 단어:2bit)

##### 완전-연관 사상의 장단점
- 장점: 새로운 블록이 캐시로 적재될 때, 라인의 선택이 매우 자유롭다.
        지역성이 높다면, 적중률이 매우 높아진다.
        비어있는 캐시 메모리가 있으면, 마음대로 주소를 저장하는 방식이다.
<br>

- 단점: 캐시 라인들의 태그들을 병렬로 검사하기 위하여 가격이 높은 연관 기억장치(Associative Memory) 및 복잡한 주변 회로가 필요하다.
        조건이나 규칙이 없어서 특정 캐시 Set 안에 있는 모든 블럭을 한번에 찾아 원하는 데이터가 있는지 검색해야 한다. 
        CAM이라는 특수한 메모리 구조를 사용해야하지만 가격이 매우 비싸다.
  
![완전연관사상이미지1](https://github.com/rt21hyuk/TIL/assets/156268464/e5222b61-2b6a-45f0-bc29-658957462210)

##### 세트 연관 사상(Set Associative Cache)
- 직접 사상과 완전-연관 사상의 조합이다.
- 주기억장치 블록 그룹이 하나의 캐시 세트를 공유하며, 그 세트에는 두 개 이상의 라인들이 적재될 수 있음
- 캐시는 v개의 세트(set)들로 나누어지며, 각 세트들은 k개의 라인들로 구성(k-way 세트-연관 사상)
<br>

##### 세트 연관 사상 기억장치 주소 형식
- 태그 필드와 세트 필드를 합한 (t+s)비트가 주기억장치의 2(t+s)블록들 중의 하나를 지정
- 그 블록이 적재될 수 있는 세트 번호: 세트 필드에 의해 지정

|태그(tag) 필드|세트(set) 필드|단어 필드|
|---|---|---|

- 앞의 [예]에 2-way 세트-연관 사상 방식을 적용하는 경우의 주소 형식: (세트 수 = 8/2 = 4개 = 2^2^개)
    Memory: 128 bytes, Cache: 32 bytes(8 Line), 2-way: 한 세트에 2line
    (태그:3bit, 세트:2bit, 단어:2bit)

- 세트 수 = 캐시 라인 수(v = m) & 세트 내 라인 수 k = 1 &rightarrow; 직접 사상
- 세트 수 = 1 & 세트 내 라인의 수 = 캐시의 전체 라인 수(k = m) &rightarrow; 완전-연관 사상
    `v: 세트 수`, `m: 라인 수`
  
![세트연관사상1](https://github.com/rt21hyuk/TIL/assets/156268464/1a4a7f58-40ca-40d7-a7a2-b0b06d5a18c4)
<br>

![세트연관사상2](https://github.com/rt21hyuk/TIL/assets/156268464/1750b923-e859-4f32-8c81-dc58cf0939c8)
